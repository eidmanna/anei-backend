<!--
@license MIT
Copyright (c) 2015 Eidmann. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="anei-backend-handler.html">


<!--
The 'anei-backend' element exposes generic backend connectivity.

Example:

    <anei-backend url="ws://localhost:8080/message"></anei-backend>
    <anei-backend-handler action="saveData" input="elemA,elemB" output="elemA,elemC"></anei-backend-handler>

-->
<script>
  'use strict';
  Polymer({
    is: 'anei-backend',
    properties: {
      url: {
        type: String
      }
    },
    ready: function() {
      this.conn = new WebSocket(this.url);
      this.conn.onclose = function(e) {
        // console.log("ws closed");
      }.bind(this);

      this.conn.onopen = function(e) {
        // console.log("ws connected");
        this._wsConnected = true;
      }.bind(this);

      this.conn.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var resolve = this._promises[data.id];
        resolve(data);
        delete this._promises[data.id];
      }.bind(this);
    },
    _wsConnected: false,
    _promises: {},
    _requestId: 0,
    request: function(template, handler) {
      // wait for startup
      if (!this._wsConnected) {
        window.setTimeout(function() {
          this.request(template, handler);
        }.bind(this), 50);
        return;
      }

      var promise = new Promise(function(resolve, reject) {
        this._promises[++this._requestId] = resolve;
        var msg = {};
        msg.id = this._requestId;

        msg.data = {};

        msg.input = handler.input;
        msg.output = handler.output;
        msg.action = handler.action;

        var input = handler.input.split(',');
        input.forEach(function(elem) {
          msg.data[elem] = template[elem];
        }.bind(this));
        this.conn.send(JSON.stringify(msg));
      }.bind(this));
      promise.then(function(msg) {
        var output = handler.output.split(',');
        output.forEach(function(elem) {
          template[elem] = msg[elem];
        }.bind(this));
      }.bind(this));

    }

  });
</script>
